//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool
//     Changes to this file will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;

public class PlayGround
{
    public Spike spike { get; set; }
    public List<Box> Boxes { get; set; }
    public Dictionary<string, Square> PlayField { get; set; }
    private bool levelCompleted;
    private string[] textFile;
    private int currLevel;

    public PlayGround()
    {
        spike = new Spike();
        PlayField = new Dictionary<string, Square>();
        Boxes = new List<Box>();
    }

    public bool CheckLevelCompleted()
    {
        foreach (Box box in Boxes)
            if (!box.StandsOnGoal)
                return false;

        Console.WriteLine("Level completed");
        levelCompleted = true;

        PlayField.Clear();

        return levelCompleted;
    }

    private void ResetPuzzle()
    {
        PlayField.Clear();
        Boxes.Clear();
        levelCompleted = false;
    }

    public void CheckMoveValid(string newSquareID, string SquareNextToNewSquareID)
    {
        bool valid = false;
        Square toMoveSquare; // represents the square the player wants to stand on
        PlayField.TryGetValue(newSquareID, out toMoveSquare);
        Square nextSquare = null; // represent the next square from toMoveSquare, necessary for moving a box

        if (toMoveSquare.Available)
        {
            if (toMoveSquare.Box != null) // if the square contains a box
            {
                // find out whether the next square the box has to move to is available
                PlayField.TryGetValue(SquareNextToNewSquareID, out nextSquare);
                if (nextSquare.Available && nextSquare.Box == null)
                    valid = true;
            }
            else // the square does not contain a box
                valid = true;
        }
        Console.WriteLine(valid);

        if (valid)
            this.UpdatePlayRound(toMoveSquare, nextSquare);
    }

    public void GenerateLevel(int level)
    {
        currLevel = level;
        var projectPath = Path.GetDirectoryName(Path.GetDirectoryName(Path.GetDirectoryName(System.Reflection.Assembly.GetExecutingAssembly().GetName().CodeBase)));
        var fullPath = new Uri(projectPath + @"\Doolhof\doolhof" + level + ".txt").LocalPath;

        // Bevat het level(speelveld)
        textFile = File.ReadAllLines(fullPath);

        int row = 0;
        int column = 0;
        char[] squares;
        Square newSquare = null;

        foreach (string line in textFile)
        {
            squares = line.ToCharArray();

            foreach (char square in squares)
            {
                switch (square)
                {
                    case '#':
                        newSquare = new WallSquare(row, column);
                        row++;
                        break;

                    case '.':
                        newSquare = new NormalSquare(row, column);
                        row++;
                        break;

                    case '@':
                        newSquare = new NormalSquare(row, column);
                        newSquare.MovableObject = spike;
                        spike.Square = newSquare;
                        row++;
                        Console.WriteLine(newSquare.ID + " contains the spike");
                        break;

                    case 'x':
                        newSquare = new GoalSquare(row, column);
                        row++;
                        break;

                    case 'o':
                        newSquare = new NormalSquare(row, column);
                        Box box = new Box();
                        newSquare.MovableObject = box;
                        box.Square = newSquare;
                        Boxes.Add(box); // add box to the array
                        row++;
                        break;

                    default: // add empty square
                        PlayField.Add("e" + row + ":" + column, null); // indicate an emty square should be written
                        row++;
                        break;
                } // end switch

                if (newSquare != null)
                    PlayField.Add(newSquare.ID, newSquare);

                newSquare = null;
            } // end for-loop -> for each char in string
            column++;
            row = 0;
            PlayField.Add("n" + row + ":" + column, null); // indicate an enter has to be written
        } // end for-loop -> for each string in string[]
        this.printField();
    }

    ///////////////////////////////////////////////// replace this method to the view
    public void printField()
    {
        Console.Clear();

        Console.WriteLine("-------------");
        for (int i = 0; i < 3; i++)
            if (i == 1)
                Console.WriteLine("| SOKOBAN   |");
            else
                Console.WriteLine("|           |");
        Console.WriteLine(("-------------"));

        Console.WriteLine("-----------------------------------------------------------");

        foreach (var square in PlayField)
            if (square.Key.Substring(0, 1).Equals("n"))
                Console.WriteLine(); // print enter
            else if (square.Key.Substring(0, 1).Equals("e"))
                Console.Write(" "); // print emtpy square
            else // normal square
                Console.Write(square.Value.PrintShape);

        Console.WriteLine("-----------------------------------------------------------");

        Console.WriteLine("> Gebruik pijltjestoetsen (s = stop, r = reset");
    }
    ///////////////////////////////////////////////////////////////////////////////////////

    public void UpdatePlayRound(Square toMoveSquare, Square nextSquare)
    {
        if (toMoveSquare.Box != null) // the new square contains a box
        {
            nextSquare.Box = toMoveSquare.Box;
            nextSquare.Box.Square = nextSquare;
            toMoveSquare.RemoveMovableObject();

            if (nextSquare is GoalSquare)
                nextSquare.Box.StandsOnGoal = true;
            else
                nextSquare.Box.StandsOnGoal = false;
        }

        spike.Square.RemoveMovableObject();
        spike.Square = toMoveSquare;
        spike.Square.Spike = spike;

        this.printField();
        this.CheckLevelCompleted();
    }
    //////////////////////////////////////////////////////////////// this method has to be deleted
                                                                  // the gameController has to invoke the
                                                                  // moveUp/moveDown/moveRight/moveLeft method
                                                                  // of the Spike / Collaborator
    public void ProcessUserInput(ConsoleKeyInfo pressedKey)
    {
        string newSquareID = null; // represents the square the player want to move to
        string squareNextToNewSquareID = null; // represent the next square from toMoveSquare, necessary for moving a box

        switch (pressedKey.Key)
        {
            // Change the ID of the squares(currSquareID)
            case ConsoleKey.UpArrow:
                newSquareID = spike.Square.Row + ":" + (spike.Square.Column - 1);
                squareNextToNewSquareID = spike.Square.Row + ":" + (spike.Square.Column - 2);
                break;
            case ConsoleKey.DownArrow:
                newSquareID = spike.Square.Row + ":" + (spike.Square.Column + 1);
                squareNextToNewSquareID = spike.Square.Row + ":" + (spike.Square.Column + 2);
                break;
            case ConsoleKey.LeftArrow:
                newSquareID = (spike.Square.Row - 1) + ":" + spike.Square.Column;
                squareNextToNewSquareID = (spike.Square.Row - 2) + ":" + spike.Square.Column;
                break;
            case ConsoleKey.RightArrow:
                newSquareID = (spike.Square.Row + 1) + ":" + spike.Square.Column;
                squareNextToNewSquareID = (spike.Square.Row + 2) + ":" + spike.Square.Column;
                break;
            case ConsoleKey.S:
                this.ResetPuzzle();
                Console.Clear();
                new GameController().SetupGame();
                break;
            case ConsoleKey.R:
                // Reset properties
                this.ResetPuzzle();
                GenerateLevel(currLevel);
                break;
        }

        if (newSquareID != null)
            this.CheckMoveValid(newSquareID, squareNextToNewSquareID);
    }
    ///////////////////////////////////////////////////////////////////////////////////////////// remove
}

